<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Interview Simulator - CareerLens AI</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3caff6",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101b22",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen flex flex-col">
    <!-- Header -->
    <header
        class="sticky top-0 z-10 flex items-center bg-background-light dark:bg-background-dark/95 backdrop-blur-md p-4 border-b border-primary/10">
        <button class="text-primary p-2 hover:bg-primary/10 rounded-full transition-colors"
            onclick="window.location.href='../dashboard/code.html'">
            <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <h1 class="text-lg font-bold leading-tight tracking-tight flex-1 text-center">Interview Simulator</h1>
        <a href="../profile_page/code.html"
            class="size-8 rounded-full bg-primary/20 border border-primary/30 flex items-center justify-center hover:bg-primary transition-colors group">
            <span class="material-symbols-outlined text-primary text-sm group-hover:text-background-dark">person</span>
        </a>
    </header>
    <main class="flex-1 overflow-y-auto px-4 py-6 space-y-6 max-w-md mx-auto w-full">
        <!-- Question Section -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span id="questionCounter"
                        class="text-[10px] font-bold uppercase tracking-wider text-primary bg-primary/10 px-2 py-1 rounded">Question
                        1 of 5</span>
                    <div id="difficultyBadge"
                        class="text-[10px] font-bold uppercase tracking-wider text-amber-500 bg-amber-500/10 px-2 py-1 rounded border border-amber-500/20">
                        Intermediate</div>
                </div>
                <div class="flex items-center gap-2 text-slate-500">
                    <span class="material-symbols-outlined text-sm">timer</span>
                    <span id="timer" class="text-sm font-mono font-bold">02:00</span>
                </div>
            </div>

            <div class="group relative p-0.5 rounded-xl bg-gradient-to-br from-primary/40 to-transparent">
                <div class="bg-white dark:bg-[#1b2327] rounded-[0.7rem] p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute -right-8 -bottom-8 size-24 bg-primary/5 rounded-full blur-2xl"></div>
                    <h2 id="questionText" class="text-xl font-bold leading-snug relative z-10">Preparing your first
                        question...</h2>
                </div>
            </div>
        </div>

        <!-- Recording/Input Area -->
        <div class="space-y-4">
            <div class="flex items-center justify-between px-1">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-semibold text-slate-600 dark:text-slate-300">Your Answer</label>
                    <div id="recordingStatus" class="flex items-center gap-1 opacity-0 transition-opacity">
                        <span class="size-2 bg-red-500 rounded-full animate-pulse"></span>
                        <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">Recording</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-medium text-slate-500">Dictation</span>
                    <label
                        class="relative flex h-6 w-11 cursor-pointer items-center rounded-full bg-slate-300 dark:bg-slate-700 p-0.5 has-[:checked]:bg-primary transition-colors">
                        <input id="micToggle" class="invisible absolute peer" type="checkbox" />
                        <div class="h-5 w-5 rounded-full bg-white shadow-md transition-all peer-checked:translate-x-5">
                        </div>
                    </label>
                </div>
            </div>
            <div class="relative">
                <textarea
                    class="w-full min-h-[180px] rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1b2327] p-4 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all placeholder:text-slate-400"
                    placeholder="Type your response here or use the microphone to dictate..."></textarea>
                <div class="absolute bottom-4 right-4 flex gap-2">
                    <div class="flex items-center justify-center rounded-full bg-primary/10 text-primary p-2">
                        <span class="material-symbols-outlined scale-90">mic</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Action Buttons -->
        <div class="flex flex-col gap-3 pt-2">
            <button
                class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2">
                <span>Submit Answer</span>
                <span class="material-symbols-outlined text-sm">send</span>
            </button>
            <button
                class="w-full bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-3 rounded-xl transition-all">
                Skip Question
            </button>
        </div>
        <!-- AI Feedback Section (Visible post-submission) -->
        <div class="space-y-4 border-t border-slate-200 dark:border-slate-800 pt-8 pb-10 hidden" id="feedbackSection">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary">analytics</span>
                <h3 class="text-lg font-bold">AI Feedback</h3>
            </div>
            <!-- Score Card -->
            <div class="bg-primary/5 border border-primary/20 rounded-xl p-4 flex items-center gap-4">
                <div class="relative flex items-center justify-center size-16">
                    <svg class="size-full" viewbox="0 0 36 36">
                        <path class="stroke-primary/20"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke-width="3"></path>
                        <path class="stroke-primary transition-all duration-1000" id="scoreCircle"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke-dasharray="0, 100" stroke-linecap="round" stroke-width="3"></path>
                    </svg>
                    <span class="absolute text-lg font-bold" id="scoreValue">0/10</span>
                </div>
                <div>
                    <p class="font-bold text-primary" id="feedbackTitle">Analyzing...</p>
                    <p class="text-sm text-slate-500 dark:text-slate-400" id="feedbackSummary">Your answer is being
                        evaluated
                        by AI.</p>
                </div>
            </div>
            <!-- Strengths & Improvements -->
            <div class="grid grid-cols-1 gap-4" id="feedbackDetails">
                <!-- Dynamically populated -->
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const rawData = localStorage.getItem('careerAnalysis');
                if (!rawData) {
                    window.location.href = '../upload_page/code.html';
                    return;
                }
                const data = JSON.parse(rawData);
                let questions = [...data.roadmap.interview_questions];

                // Handle selected question from dashboard
                const selectedQ = localStorage.getItem('selectedInterviewQuestion');
                if (selectedQ) {
                    // Move to front if it exists, or add if it doesn't
                    questions = [selectedQ, ...questions.filter(q => q !== selectedQ)];
                    localStorage.removeItem('selectedInterviewQuestion');
                }

                let currentIdx = 0;

                // Load User Avatar
                const userProfile = JSON.parse(localStorage.getItem('userProfile'));
                if (userProfile && userProfile.avatar) {
                    const profileContainer = document.querySelector('a[href="../profile_page/code.html"]');
                    if (profileContainer) {
                        profileContainer.innerHTML = `<img src="${userProfile.avatar}" class="size-full rounded-full border border-primary/30" alt="Profile">`;
                    }
                }

                const questionText = document.getElementById('questionText');
                const questionCounter = document.getElementById('questionCounter');

                // Session Protection
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (!isLoggedIn) {
                    window.location.href = '../landing_page/code.html';
                }

                const feedbackSection = document.getElementById('feedbackSection');
                const submitBtn = document.querySelector('button.bg-primary');
                const skipBtn = document.querySelector('button.bg-slate-200');
                const answerArea = document.querySelector('textarea');
                const timerEl = document.getElementById('timer');
                const micToggle = document.getElementById('micToggle');
                const recordingStatus = document.getElementById('recordingStatus');

                let timeLeft = 120;
                let timerInterval;

                function startTimer() {
                    clearInterval(timerInterval);
                    timeLeft = 120;
                    updateTimerDisplay();
                    timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            alert('Time is up! Please submit your answer.');
                        }
                    }, 1000);
                }

                function updateTimerDisplay() {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    if (timeLeft <= 30) {
                        timerEl.classList.add('text-red-500', 'animate-pulse');
                    } else {
                        timerEl.classList.remove('text-red-500', 'animate-pulse');
                    }
                }

                micToggle.addEventListener('change', () => {
                    if (micToggle.checked) {
                        recordingStatus.classList.remove('opacity-0');
                    } else {
                        recordingStatus.classList.add('opacity-0');
                    }
                });

                function updateQuestion() {
                    if (!questions || questions.length === 0) {
                        questionText.textContent = "Tell me about yourself and your career goals.";
                    } else {
                        questionText.textContent = questions[currentIdx];
                        questionCounter.textContent = `Question ${currentIdx + 1} of ${questions.length}`;
                    }
                    feedbackSection.classList.add('hidden');
                    answerArea.value = '';
                    submitBtn.disabled = false;
                    submitBtn.classList.replace('bg-slate-700', 'bg-primary');
                    submitBtn.innerHTML = `<span>Submit Answer</span><span class="material-symbols-outlined text-sm">send</span>`;

                    // Reset Score Circle
                    document.getElementById('scoreValue').textContent = "0/10";
                    document.getElementById('scoreCircle').setAttribute('stroke-dasharray', `0, 100`);

                    startTimer();
                }

                updateQuestion();

                submitBtn.addEventListener('click', async () => {
                    const answer = answerArea.value.trim();
                    if (!answer) {
                        alert('Please type or record an answer first.');
                        return;
                    }

                    clearInterval(timerInterval);

                    // Loading state
                    submitBtn.disabled = true;
                    submitBtn.classList.replace('bg-primary', 'bg-slate-700');
                    submitBtn.innerHTML = `<span>Analyzing...</span><span class="material-symbols-outlined animate-spin text-sm">cycle</span>`;
                    feedbackSection.classList.remove('hidden');
                    document.getElementById('feedbackTitle').textContent = "AI is Thinking...";
                    document.getElementById('feedbackSummary').textContent = "Your answer is being evaluated by AI.";
                    document.getElementById('scoreValue').textContent = "0/10";
                    document.getElementById('scoreCircle').setAttribute('stroke-dasharray', `0, 100`);
                    document.getElementById('feedbackDetails').innerHTML = '';

                    try {
                        const apiHost = window.location.hostname || '127.0.0.1';
                        const response = await fetch(`http://${apiHost}:9000/api/feedback`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                question: questions[currentIdx] || "Tell me about yourself",
                                answer: answer
                            })
                        });

                        if (!response.ok) throw new Error('API Error');
                        // Handle both possible response structures
                        let feedback = await response.json();

                        // Fallback logic if backend returns raw string or partial
                        if (typeof feedback === 'string') {
                            try { feedback = JSON.parse(feedback); } catch (e) { }
                        }

                        // Render Feedback
                        const score = feedback.score || 0;
                        document.getElementById('feedbackTitle').textContent = feedback.feedback_title || "Analysis Complete";
                        document.getElementById('feedbackSummary').textContent = feedback.feedback_summary || "Here is your feedback.";
                        document.getElementById('scoreValue').textContent = `${score}/10`;

                        // Animate score circle
                        setTimeout(() => {
                            document.getElementById('scoreCircle').setAttribute('stroke-dasharray', `${score * 10}, 100`);
                        }, 100);

                        const strengths = feedback.strengths || [];
                        const improvements = feedback.improvements || [];

                        document.getElementById('feedbackDetails').innerHTML = `
                        <div class="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-4">
                            <h4 class="text-emerald-500 font-bold text-sm mb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">check_circle</span> Strengths
                            </h4>
                            <ul class="text-sm space-y-2 text-slate-600 dark:text-slate-300 list-disc list-inside">
                                ${strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="bg-amber-500/5 border border-amber-500/20 rounded-xl p-4">
                            <h4 class="text-amber-500 font-bold text-sm mb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">error</span> Improvements
                            </h4>
                            <ul class="text-sm space-y-2 text-slate-600 dark:text-slate-300 list-disc list-inside">
                                ${improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                        <button id="nextQuestionBtn" class="w-full mt-4 py-3 border border-primary text-primary font-bold rounded-xl hover:bg-primary/5 transition-colors">
                            Next Question
                        </button>
                    `;

                        // Bound the next question button dynamically
                        document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                            currentIdx = (currentIdx + 1) % questions.length;
                            updateQuestion();
                            feedbackSection.scrollIntoView({ behavior: 'smooth' }); // Scroll back up/down if needed
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        });

                        feedbackSection.scrollIntoView({ behavior: 'smooth' });

                    } catch (err) {
                        console.error(err);
                        alert('Analysis failed. Try again.');
                        startTimer();
                        submitBtn.disabled = false; // Re-enable if failed
                        submitBtn.classList.replace('bg-slate-700', 'bg-primary');
                        submitBtn.innerHTML = `<span>Submit Answer</span><span class="material-symbols-outlined text-sm">send</span>`;
                    }
                });

                skipBtn.addEventListener('click', () => {
                    currentIdx = (currentIdx + 1) % questions.length;
                    updateQuestion();
                });
            });
        </script>
    </main>
    <!-- Bottom Navigation Bar -->
    <nav
        class="sticky bottom-0 bg-white dark:bg-[#1b2327] border-t border-slate-200 dark:border-slate-800 px-4 pb-6 pt-2 flex justify-between items-center z-20">
        <a class="flex flex-col items-center gap-1 text-slate-400 group" href="../profile_page/code.html">
            <span class="material-symbols-outlined group-hover:text-primary transition-colors">person</span>
            <span class="text-[10px] font-medium">Profile</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-400 group" href="../dashboard/code.html">
            <span class="material-symbols-outlined group-hover:text-primary transition-colors">analytics</span>
            <span class="text-[10px] font-medium">Results</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-primary" href="../interview_simulator/code.html">
            <span class="material-symbols-outlined">school</span>
            <span class="text-[10px] font-medium">Simulator</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-400 group" href="../upload_page/code.html">
            <span class="material-symbols-outlined group-hover:text-primary transition-colors">upload</span>
            <span class="text-[10px] font-medium">Upload</span>
        </a>
    </nav>
</body>

</html>